---
title: "bis620final"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{bis620final}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bis620final)
library(lubridate)
library(dplyr)
library(ggplot2)
library(gtsummary)
library(survival)
library(survminer)

data(adae)
data(adlb)
data(adls)
data(adpm)
data(adrsp)
data(adsl)
data(biomark)

```





It was hypothesized that patients in the study with KRAS mutations in exons 2, 3, and 4 would have poorer outcomes. 
Since there are two columns referencing exon 3 (c61 and c59/c61), we use both of them for determining whether a patient is mutant or not. A patient will be considered "Mutant" if there is at least one "Mutant" biomarkers in KRAS exons 2, 3, 4. Patients will be considered "Wild-type" if they are not "Mutant" and they have more "Wild-type" markers than "Unknown" or "Failure". You can also use the following functions to investigate other mutations of interest. 

```{r}
# merge dl$adsl and dl$biomark based on SUBJID
demo = left_join(adsl, biomark, by = "SUBJID")

# create a new variable marker to record the patient marker for each patient: 
# "Mutant", "Wild-type", or ""
demo <- determine_mutant(demo, c("BMMTR1", "BMMTR2", "BMMTR3", "BMMTR15"))
```

- Create a plot of number of total mutant, wild-type, and unknown KRAS counts per patient. That is, create a plot where the x-axis has the values "Mutant", "Wild-type", and "Unknown" with the y-axis showing the total count for those values over all patients.

```{r}
plot_mutant_cnt(demo, "marker")
```

- Let the outcome be whether the patient died during the study. 

  - Is the marker prognostic with respect to the death outcome? 
  - Is it predictive with respect to the death outcome? 

**Statistical Analysis:**
Descriptive statistics will be used to summarize baseline characteristics, and survival outcomes will be compared using appropriate statistical tests. In the machine learning analysis, significance testing for individual variables and model performance will be assessed through appropriate statistical measures. Analysis of Variance (ANOVA) will be performed to assess the significance of differences in means across the treatment groups.

To test whether the marker is prognostic with respect to the death outcome, we can formulate the null hypothesis as that the death outcome is independent of biomarker, that is, biomarker is not prognostic with respect to the death outcome. If the p-value obtained from the chi-squared test is less than significance level $\alpha=0.05$, we can conclude that the biomarker is prognostic with respect to the death outcome.
```{r}
# create a contingency table of death vs. marker and use chi-squared test to test whether marker is prognostic to death outcome
# use only observations with marker "Mutant" or "Wild-type"
chi_square_test(demo)
```

Since the p-value 6.513e-06 is less than $\alpha=0.05$, we can reject the null hypothesis and conclude that the biomarker is prognostic with respect to the death outcome. 

Next, we perform a survival analysis to death outcome with respect to biomarker. 

**Survival Analysis:**
Survival analysis will be conducted on each treatment group to evaluate progression-free survival and overall survival outcomes. Kaplan-Meier curves will be generated, and log-rank tests will be employed to assess the significance of observed differences.
```{r}
# create a new variable of the combination of treatment and biomarker
demo$marker_treat <- paste0(demo$marker, "_", demo$treatment)
create_KM_plot(demo)
```

We can also retrieve summary information from the survival analysis via the following function.
```{r}
create_survival_info(demo)
```

Next, we solve the problem using from a logistic regression approach. 

**Machine Learning Analysis:**
Logistic regression will be employed to investigate the predictive value of various variables in determining life expectancy. The analysis will utilize death outcome as the target variable (a binary response) and other relevant clinical, molecular, and demographic variables as features. P-value will be computed to quantify the significance of individual features in predicting life expectancy. This information will be utilized as criteria for feature selection, facilitating the identification of key variables influencing survival outcomes. 
```{r}
# fit a logistic regression model on the joint effect of treatment and marker
# use only observations with marker "Mutant" or "Wild-type"
fit_logistic(demo)
```


We also provide a Generalized Additive Model (GAM) method on modeling the relationship between life expectancy and biomarker and treatment.
```{r}
library(mgcv)

# fit a gam model
gam_demo <- demo
gam_demo$ATRT <- factor(gam_demo$ATRT)
gam_demo$marker <- factor(gam_demo$marker)
gam_demo$marker <- ordered(gam_demo$marker)
gam_demo$PRSURG <- factor(gam_demo$PRSURG)
gam_demo$SEX <- factor(gam_demo$SEX)
gam_demo$RACE <- factor(gam_demo$RACE)

gam_model <- gam(DTH ~ ATRT + PRSURG + PFSDYCR + s(AGE, by=marker)
                 + SEX + RACE + B_WEIGHT + B_HEIGHT + marker, data = gam_demo, 
                 family = binomial(), method = "REML")
plot(gam_model)
summary(gam_model)
```


The next model we proposed is the generalized boosted regression model (GBM) for investigating the relationship between the death outcome and predictors of interest. Generalized boosted regression models can be a good fit for binary classification problem, and the predictor importance can also be reported to boost understanding of the impact of predictors on the death outcome. 
```{r}
# fit a gbm model 
gbm_demo <- demo
gbm_demo$ATRT <- factor(gbm_demo$ATRT)
gbm_demo$marker <- factor(gbm_demo$marker)
gbm_demo$AGE <- factor(gbm_demo$AGE)
gbm_demo$PRSURG <- factor(gbm_demo$PRSURG)
gbm_demo$SEX <- factor(gbm_demo$SEX)
gbm_demo$RACE <- factor(gbm_demo$RACE)

# print variable importance
fit_gbm(gbm_demo)
```
























